\documentclass[10pt, onecolumn, aps, prb, superscriptaddress, floatfix, showpacs, notitlepage]{revtex4-1}
\pdfoutput=1

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{amssymb}
% \usepackage{wasysym}
\usepackage{bm}
\usepackage{xcolor}
\usepackage[colorlinks, citecolor={blue!50!black}, urlcolor={blue!50!black}]{hyperref}
\usepackage{bookmark}
\usepackage{tabularx}
\usepackage{mathtools}
\usepackage{microtype}
\usepackage[load=physical,load=abbr]{siunitx}

\DeclareMathOperator{\sgn}{sgn}
\DeclareMathOperator{\im}{Im}
\DeclareMathOperator{\re}{Re}

\newcommand{\ev}[1]{\langle#1\rangle}
\newcommand{\bra}[1]{\langle #1|}
\newcommand{\ket}[1]{|#1\rangle}
\newcommand{\bracket}[2]{\langle #1|#2\rangle}

\graphicspath{{figures/}}

\begin{document}

\author{nice people ;-)}
\affiliation
{Delft University of Technology}

\title{kpm expansion of second order perturbation matrix elements}

% \begin{abstract}
%     Abstract
% \end{abstract}
\maketitle

\section{Quasi-Degenerate Perturbation theory: standard approach}

\subsection{Problem definition}

We start by separating initial Hamiltonian into unperturbed part $H^0$ and perturbation $\lambda H^{\prime}\,$ with $\lambda$ as a small parameter:
\begin{equation}
H = H^{0} + \lambda H^{\prime} \,.
\end{equation}

We assume that eingestates and energies of $H^{0}$ are known:
\begin{equation}
H^0 \ket{\psi_n} = \epsilon_n \ket{\psi_n} \,.
\end{equation}

We now split states $\ket{\psi_n}$ into two groups, $A$ and $B$.
We are interested in states from group $A$ whereas effect of states $B$ we want to include via perturbation theory.
We assume that these two group of states are clearly separated in energies.
We write operator $X$ restricted to various blocks as $X_{AA}$, $X_{BB}$, $X_{AB}$ and $X_{BA}$.


\subsection{L\"owdin partitioning}
\label{sec:lowdin}
L\"owdin partitioning (also known as Schriefferâ€“Wolff transformation), see Winkler's book,~\cite{winkler} provide us with the extension of standard perturbation theory to the case of quasi-degenerate states.
We apply a unitary basis transformation with skew Hermitian $S$ ($S^\dagger = -S$):
\begin{equation}
\tilde{H} = e^{-S} H \, e^{S}\,.
\end{equation}
The transformation should be the identity when the perturbation vanishes and we expand $S$ as a series in successive orders of the perturbation
\begin{equation}
S = \sum_{j = 1}^{\infty} \lambda^j S^{(j)}.
\end{equation}
The transformed Hamiltonian (using the Baker-Campbell-Hausdorff formula) is
\begin{equation}
\label{eq:lowdin-h}
\tilde{H}
    = \sum_{j=0}^{\infty}\frac{1}{j!} [H,\,S]^{(j)}
    = \sum_{j=0}^{\infty}\frac{1}{j!} [H^0 + \lambda H^1,\,S]^{(j)}
    + \sum_{j=0}^{\infty}\frac{1}{j!} [\lambda H^2,\,S]^{(j)}\,,
\end{equation}
where the commutator $[A, B]^{(j)}$ is defined as
\begin{equation}
[A, B]^{(j)} = [\ldots[[A,\underbrace{\,B],\,B],\ldots,\,B]}_\text{$j$ times},
\end{equation}
and we introduced $H^1 = H'_{AA} + H'_{BB}$, $H^2 = H'_{AB} + H'_{BA}$.
The requirement on the $S$ we seek is $\tilde{H}_{AB} = \tilde{H}_{BA} = 0$ and we call $\tilde{H}_{AA}$ the effective Hamiltonian.
We choose $S$ to be block off-diagonal such that $S_{AA} = S_{BB} = 0$.

To do $n$'th order perturbation theory we demand the equations to be satisfied for all terms up to $\lambda^n$.
Separating terms that contribute to diagonal and off-diagonal terms ($\tilde{H}_{d}$ and $\tilde{H}_{n}$) we find:
\begin{subequations}
\begin{eqnarray}
\label{eq:lowdin-hd}
\tilde{H}_{d}
    &=& \sum_{j=0}^{\infty}\frac{1}{(2j)!} [H^0 + \lambda H^1,\,S]^{(2j)}
    + \sum_{j=0}^{\infty}\frac{1}{(2j+1)!} [\lambda H^2,\,S]^{(2j+1)}\,,\\
\label{eq:lowdin-hn}
\tilde{H}_{n}
    &=& \sum_{j=0}^{\infty}\frac{1}{(2j+1)!} [H^0 + \lambda H^1,\,S]^{(2j+1)}
    + \sum_{j=0}^{\infty}\frac{1}{(2j)!} [\lambda H^2,\,S]^{(2j)}\,.
\end{eqnarray}
\end{subequations}
We solve \eqref{eq:lowdin-hn} up to $n-1$ order by inserting the expansion $S = \sum_{j = 1}^{n-1} \lambda^j S^{(j)}$ and letting the sums in $j$ run to $\left\lfloor (n-1)/2 \right\rfloor$, this produces all terms up to $n-1$ order.
We observe that at $j$'th order $S^{(j)}$ only appears in a single commutator, allowing to rearrange the $j$'th order terms in the equation $\tilde{H}_{n} = 0$ as
\begin{equation}
{[H^0,\,S^{(j)}]} = Y^{(j)}
\end{equation}
where $Y^{(j)}$ only depends on lower orders of $S$.
We generate the $Y$'s using symbolic computer algebra.
The first few terms are:
\begin{subequations}
\label{eq:lowdin-get-s}
\begin{align}
{[H^0,\,S^{(1)}]} &= Y^{(1)} = -H^2\,,\\
{[H^0,\,S^{(2)}]} &= Y^{(2)} = -[H^1,\,S^{(1)}]\,,\\
{[H^0,\,S^{(3)}]} &= Y^{(3)} = -[H^1,\,S^{(2)}] - \frac{1}{3} [[H^2,\,S^{(1)}],\,S^{(1)}]\,.
\end{align}
\end{subequations}
As the $Y$'s are purely off-diagonal Hermitian, it is possible to write only $Y^{(j)}_{AB}$ in terms of $S_{AB}$, $S_{BA}$ and the restricted components of $H$.

The equations \eqref{eq:lowdin-get-s} can be iteratively solved as
\begin{equation}
\label{eq:lowdin-s-from-y}
S^{(j)}_{ml} = \frac{Y^{(j)}_{ml}}{E_m - E_l}
\end{equation}
where indices $m$ and $l$ correspond to states in the $A$ and $B$ subspace respectively.
With the $n-1$ order expansion of $S$ at hand, we substitute it into \eqref{eq:lowdin-hd} with the sum over $j$ running to $\left\lfloor n/2 \right\rfloor$, or directly into \eqref{eq:lowdin-h} with the sum over $j$ running to $n$, to produce $\tilde{H}_{d}$ up to $n$'th order.

Also writing the transformed Hamiltonian as a sum of successive orders of the perturbation
\begin{equation}
\tilde{H} = \tilde{H}^{(0)} + \lambda \tilde{H}^{(1)} + \lambda^2 \tilde{H}^{(2)} + \ldots\,,
\end{equation}
The explicit solution, for first two orders, is:
\begin{subequations}
\label{lowdin-explicit}
\begin{align}
    \tilde{H}^{(0)}_{mn} &= H^0_{mn} \,,\\
    \tilde{H}^{(1)}_{mn} &= H^1_{mn} \,,\\
    \tilde{H}^{(2)}_{mn} &= \frac{1}{2} \sum_{l\in B}
    H^{2}_{m l} H^{2}_{l n}
    \left(\frac{1}{E_m - E_l} + \frac{1}{E_n - E_l}\right)\,,
\end{align}
\end{subequations}
where $m, n$ indices go over states from group $A$, and $l$ in group $B$.



\subsection{Perturbation as polynomial in free parameters}
From practical point of view, we usually treat $H^{\prime}$ as polynomial in some free parameters $\alpha$
\begin{equation}
H^{\prime} = \sum_\alpha \lambda_\alpha H^{\prime}_\alpha\,,
\end{equation}
where $\lambda_\alpha$ can be in example $k_x\,$, $k_x^2\,$, $B_z\,$, etc.
Taking that into account and calculating matrix elements in Eq.~\eqref{lowdin-explicit} explicitly we obtain:
\begin{subequations}
\label{lowdin-explicit}
\begin{align}
    \tilde{H}^{(0)}_{mn} &= \epsilon_m \delta_{m,n} \,,\\
    \tilde{H}^{(1)}_{mn} &= \sum_{\alpha} \lambda_\alpha \bra{\psi_m} H^{\prime}_\alpha \ket{\psi_n} \,,\\
    \tilde{H}^{(2)}_{mn} &= \frac{1}{2} \sum_{\alpha,\beta} \lambda_\alpha\lambda_\beta\sum_{l\in B}
    \left(\frac{\bra{\psi_m}H^{\prime}_{\alpha}\ket{\psi_l}\bra{\psi_l}H^{\prime}_{\beta}\ket{\psi_n}}{E_m - E_l} + \frac{\bra{\psi_m}H^{\prime}_{\alpha}\ket{\psi_l}\bra{\psi_l}H^{\prime}_{\beta}\ket{\psi_n}}{E_n - E_l}\right)\,,
\end{align}
\end{subequations}



\section{kpm expansion}

\subsection{Main idea}

The second order contribution to the effective Hamiltonian can be expressed as
\begin{align}
\tilde{H}^{(2)}_{i,j} &= \frac{1}{2}
\bra{\psi_i} H^{\prime}
\left[
\sum_\mu
\frac{\ket{\psi_\mu} \bra{\psi_\mu}}{\epsilon_j-\epsilon_\mu}
\right]
H^{\prime} \ket{\psi_j}
+
\frac{1}{2}
\bra{\psi_i} H^{\prime}
\left[
\sum_\mu
\frac{\ket{\psi_\mu} \bra{\psi_\mu}}{\epsilon_i-\epsilon_\mu}
\right]
H^{\prime} \ket{\psi_j}
\\
&= \frac{1}{2}
\bra{\psi_i} H^{\prime}
\left[P_B
\frac{1}{\epsilon_j-H^0}
P_B\right]
H^{\prime} \ket{\psi_j}
+
\frac{1}{2}
\bra{\psi_i} H^{\prime}
\left[P_B
\frac{1}{\epsilon_i-H^0}
P_B\right]
H^{\prime} \ket{\psi_j},
\end{align}

where $P_B$ is a projector over the space $B$ defined by $\{\psi_\mu\}_\mu$,
and we see the action of a Green's function defined as

$$
G(\epsilon, H^0) = \frac{1}{\epsilon-H^0}.
$$

This function can be expanded with the KPM, with the vectors of the expansion
being

$$
\ket{\phi_i} = P_B H^{\prime}\ket{\psi_i},
$$


such that


\begin{align}
\tilde{H}^{(2)}_{i,j} &= \frac{1}{2}
\bra{\phi_i} G(\epsilon_j, H^0) \ket{\phi_j}
+
\frac{1}{2}
\bra{\phi_i} G(\epsilon_i, H^0) \ket{\phi_j}
\end{align}

This calculation can be simplified by collecting the vectors to matrices, define $\Phi$ as the matrix consisting of columns that are $\ket{\phi_i}$ and $\Xi$ whose columns are $G(\epsilon_i, H^0) \ket{\phi_i}$. With this:
\begin{equation}
\tilde{H}^{(2)} = \frac{1}{2} (\Phi^\dag \Xi + \text{h.c.})
\end{equation}

\subsection{Multiple expansion parameters}

It is common that there are multiple small parameters, i.e. the perturbed Hamiltonian is
\[H = H^0 + \sum_{\alpha} \lambda_{\alpha} H^{\prime}_{\alpha}\]
and we seek the second order effective Hamiltonian as
\[\tilde{H}_{eff} = \tilde{H}^{(0)} +  \sum_{\alpha} \lambda_{\alpha} \tilde{H}^{(1)}_{\alpha} +  \sum_{\alpha\beta} \lambda_{\alpha}\lambda_{\beta}\tilde{H}^{(2)}_{\alpha\beta}.\]
Similar as before, we introduce $\Phi_{\alpha}$ as the collection of column vectors $P_B H^{\prime}_{\alpha}\ket{\psi_i}$ and $\Xi_{\alpha}$ as $G(\epsilon_i, H^0) P_B H^{\prime}_{\alpha}\ket{\psi_i}$. With this
\[\tilde{H}^2_{\alpha\beta} = \frac{1}{2} (\Phi_{\alpha}^\dag \Xi_{\beta} + \Xi_{\alpha}^\dag\Phi_{\beta})\]
which is also valid if the expansion coefficients do not commute.

\subsection{Using KPM in higher orders}

To use KPM efficiently, we want to avoid using and explicit basis for the $B$ subspace.
We observe that the expressions \eqref{eq:lowdin-get-s} for $Y$ and \eqref{eq:lowdin-hd} for $\tilde{H}_{AA}$ can be expanded in terms of the restricted operators (i.e. $H'_{AA}$, $H'_{AB}$, etc.).
Whenever two terms with $A$ indices are adjacent, we may insert a projector onto the $A$ states $P_A = \sum_m | m \rangle\langle m |$ with a full basis of $A$ states $| m \rangle$.
Whenever two terms with $B$ indices are adjacent, we insert a projector onto the $B$ subspace $P_B = 1 - \sum_m | m \rangle\langle m |$. This allows to remove the restriction from one of the adjecent terms, for example
\begin{equation}
\langle m | S_{AB} H'_{BB} S_{BA} | m' \rangle = \langle m | P_A S P_B P_B H' P_B P_B S P_A  | m' \rangle = \langle m | S_{AB} H' S_{BA} | m' \rangle = \left(S_{AB}\right)_{mi} H'_{ij} \left(S_{BA}\right)_{j m'}
\end{equation}
with indices $i$, $j$ running over the full Hilbert space and $m$, $m'$ on the basis of the $A$ subspace.
It is possible to replace all $H_{BB}$ terms with $H$ because there is only one $H$ in every product, all the other terms are $S$'s.
This is advantageous as $H'$ acting on the full Hilbert space of size $N$ can be represented as a sparse matrix of $O(N)$ nonzero entries, while $S_{AB}$ and other off-diagonal components can be stored as small dense matrices with $O(N a)$ entries where $a = \dim(A)$.

Now we rewrite \eqref{eq:lowdin-s-from-y} in terms of the Green's function:
\begin{equation}
\left(S^{(n)}_{AB}\right)_{mi} =\sum_j \left(Y^{(n)}_{AB}\right)_{mj} \left(\frac{1}{E_m - H_0}\right)_{ji} = \sum_j \left[G(E_m, H_0)_{ij} \left({Y^{(n)}_{AB}}^{\dagger} \right)_{jm}\right]^{\dagger}
\end{equation}
where we used that $S_{AB} P_B = S_{AB}$, $Y_{AB} P_B = Y_{AB}$ and that $G(E, H_0)$ doesn't mix the $A$ and $B$ subspaces.
For numerical stability reasons, we still apply $P_B$ from the right in practice.
Following the procedure outlined in section \ref{sec:lowdin} we successively generate all $S$ terms and produce $\tilde{H}_{AA}$, the only difference is using the above basis convention.

The computational complexity of generating the $n$'th order effective Hamiltonian (in the case of a single small parameter) is $O(n^2 a N M)$, where $M$ is the number of KPM moments, practically chosen to be at the order of bandwidth/gap.
We obtain this estimate by the following reasoning: A single evaluation of the KPM Green's function on a vector costs $O(NM)$. To get $S^{(j)}$, we need to apply $G$ to $(a j)$ vectors on the right hand side, as $Y^{(j)}$ is a $j$'th order polynomial of the small parameter.
We argue that the KPM step is the costliest part of the procedure, because evaluation of $Y$ and $\tilde{H}$ only involves products of small or sparse matrices.

There is, however, a combinatorical factor in the number of terms involved in these expressions, which grows exponentially with $j$.
At high orders $Y^{(j)}$ contains $O(2^j)$ terms with a single small parameter.
It is likely more efficient to directly evaluate the commutator series giving $Y^{(j)}$ by substituting the $j-1$ order expansion of $S$ with numerical coefficients.
Truncating to terms of at most order $j$ after every multiplication, this only takes $O(j^3)$ time.
These combinatorical factors are even larger if there are multiple small parameters in the expansion.
We defer in-depth analysis of the complexity and possible optimizations of high order expansions for now.

\subsection{Green's function expansion with KPM}

A function of a parameter and a Hamiltonian is expressed as

$$
f(\epsilon, H) = \sum_k f(\epsilon, E_k) \ket{\psi_k}\bra{\psi_k},
$$

where the funcion $f$ is expanded in KPM as

\begin{align}
f(\epsilon, E_k) &= \frac{2}{\pi}\sum_m c_m(\epsilon)T_m(E_k)\\
c_m(\epsilon) &=\frac{1}{1+\delta_{m,0}}
\int_{-1}^1 \frac{f(\epsilon, E_k) T_m(E_k)}{\sqrt{1-E_k^2}}\mathrm{d}E_k.
\end{align}

To simplify the calculations we can instead expand

\begin{align}
\sqrt{1-E_k^2}f(\epsilon, E_k) &= \frac{2}{\pi}\sum_m c_m(\epsilon)T_m(E_k)\\
c_m(\epsilon) &=\frac{1}{1+\delta_{m,0}}
\int_{-1}^1 {f(\epsilon, E_k) T_m(E_k)}\mathrm{d}E_k.
\end{align}


The solution is expanded elsewhere\cite{Garcia2014} for the rescaled
Hamiltonian $\tilde{H}=(H-bI)/a$, and rescaled energies
$\tilde{\epsilon}=(\epsilon-b)/a$.

\begin{align}
f(\epsilon, H)^\pm &= \frac{1}{\epsilon-H \pm i0}\\
f(\epsilon, H)^\pm &= \frac{1}{\tilde{\epsilon}a+b-\tilde{H}a-b \pm i0}\\
f(\epsilon, H)^\pm &= a^{-1}\frac{1}{\tilde{\epsilon}-\tilde{H} \pm i0}\\
f(\epsilon, H)^\pm_M &= \mp \frac{2i}{a\sqrt{1-\epsilon^2}}
\sum_{m=0}^{M}\frac{g_m}{1+\delta_{m,0}}
\exp(\pm i\,m\,\mathrm{arccos}(\epsilon)) T_m(H)
\end{align}


% In our case, we can solve the last expression as
%
% \begin{align}
% f(\epsilon, E) &= \frac{1}{\epsilon-E}\\
% T_m(E) &= \cos (m\,\mathrm{arcos}(E))\\
% \phi &= \mathrm{arcos}(E)\\
% \Rightarrow
% {\mathrm{d}E}
% &= {\mathrm{d}\cos(\phi)} = -{\sin(\phi)} \mathrm{d}\phi\\
% &\rightarrow\\
% c_m(\epsilon) &=
% \frac{1}{1+\delta_{m,0}}
% \int_0^{\pi}
% {f(\epsilon, \cos(\phi)) \cos (m\,\phi)} {\sin(\phi)}
% \mathrm{d}\phi\\
% c_m(\epsilon) &=
% \frac{1}{1+\delta_{m,0}}
% \int_0^{\pi}
% \frac{\cos (m\,\phi)\sin(\phi)}{\epsilon-\cos(\phi)}
% \mathrm{d}\phi\\
% \theta &= \epsilon - \cos(\phi)\\
% \Rightarrow \mathrm{d}\theta &= -\mathrm{d}\cos(\phi)
% \\
% &= \sin(\phi)\mathrm{d}\phi


% \section{Introduction}

% \subsection{}

% \begin{figure}[!h]
% \centering
% \includegraphics[width=\linewidth]{name}
% \caption{}
% \label{fig1}
% \end{figure}

\begin{thebibliography}{2}
\bibitem{Garcia2014}Real-space calculation of the conductivity tensor for disordered topological matter
Jose H. Garcia, Lucian Covaci, Tatiana G. Rappoport. Phys. Rev. Lett. 114, 116602 (2015)
\end{thebibliography}


\end{document}
